<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ŸÖÿ≠ŸàŸÑ ŸàŸÖÿ≠ÿ±ÿ± ÿßŸÑÿµŸàÿ± ÿßŸÑÿ∞ŸÉŸä</title>
    
    <!-- === PWA Additions === -->
  <meta name="theme-color" content="#f4f7f9">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon-1440.png">
  <link rel="apple-touch-icon" href="icon-1440.png">
  <!-- ============================= -->
    
    <!-- Library to handle HEIC files -->
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
    <!-- Library to create ZIP files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <style>
        :root {
            --primary-color: #e67e22; --primary-hover: #d35400;
            --secondary-color: #34495e; --secondary-hover: #2c3e50;
            --background-color: #f4f7f9; --container-bg-color: #ffffff;
            --text-color: #333; --text-light-color: #ffffff;
            --border-color: #e0e0e0; --disabled-color: #bdc3c7;
        }

        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--background-color); color: var(--text-color);
            margin: 0; padding: 20px; direction: rtl;
            display: flex; flex-direction: column; align-items: center; min-height: 100vh;
        }
        
        button, input, select { font-family: inherit; }

        .container {
            width: 100%; max-width: 900px; background: var(--container-bg-color);
            padding: 40px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.07);
            text-align: center;
        }

        h1 {
            color: var(--text-color); margin: 0 0 30px 0; font-weight: bold; font-size: 2em;
        }
        h1 span { color: var(--primary-color); font-weight: 900; }

        #uploadArea {
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 40px 20px; border: 2px dashed #d0dbe2; border-radius: 12px;
            cursor: pointer; transition: border-color 0.3s, background-color 0.3s;
        }
        #uploadArea.dragging, #uploadArea:hover {
            border-color: var(--primary-color); background-color: #fffaf5;
        }
        #uploadArea .primary-text { font-size: 1.2em; font-weight: 600; margin: 0 0 10px 0; }
        #uploadArea .secondary-text { font-size: 1em; color: #777; margin: 0 0 25px 0; }
        .upload-button {
            background-color: var(--primary-color); color: var(--text-light-color);
            height: 44px; line-height: 44px; padding: 0 35px; border-radius: 8px;
            font-weight: bold; display: inline-block; transition: background-color 0.3s;
            border: none; font-size: 1.1em;
        }
        #uploadArea:hover .upload-button { background-color: var(--primary-hover); }
        #fileInput { display: none; }

        #imageEditor { display: none; text-align: right; }
        
        #singleEditorView { display: none; }
        #previewContainer {
            background-color: #f9f9f9; border: 1px solid var(--border-color);
            border-radius: 8px; display: flex; justify-content: center; align-items: center;
            padding: 15px; min-height: 350px; position: relative; cursor: pointer; margin-bottom: 30px;
        }
        #previewImage {
            max-width: 100%; max-height: 450px; object-fit: contain;
            border-radius: 4px; pointer-events: none;
        }
        
        #batchEditorView { display: none; }
        #fileListContainer {
            max-height: 400px; overflow-y: auto; display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px; padding: 15px; background-color: #f9f9f9;
            border-radius: 8px; border: 1px solid var(--border-color); margin-bottom: 30px;
        }
        .file-item {
            background: #fff; border: 1px solid var(--border-color); border-radius: 8px;
            padding: 8px; text-align: center; font-size: 0.8em; overflow: hidden;
        }
        .file-item img {
            width: 100%; height: 80px; object-fit: cover; border-radius: 4px; margin-bottom: 5px;
        }
        .file-item-name { word-wrap: break-word; line-height: 1.3; }

        .controls-layout { display: flex; gap: 30px; }
        #controlsContainerSingle, #controlsContainerBatch {
             display: flex; gap: 20px; flex-wrap: wrap; width: 100%;
        }
        .control-group {
            border: 1px solid var(--border-color); padding: 15px;
            border-radius: 8px; flex: 1; min-width: 280px;
        }
        .control-group h3 {
            text-align: center; margin: 0 0 15px 0; font-size: 1.1em; font-weight: bold;
            padding-bottom: 10px; color: var(--secondary-color);
        }
        .control-row { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .control-row label { flex-basis: 70px; flex-shrink: 0; font-weight: bold; font-size: 0.9em; }
        .control-row input[type="number"], .control-row select {
            width: 100%; padding: 8px 10px; border-radius: 4px; border: 1px solid var(--border-color);
            outline: none; transition: border-color 0.3s, box-shadow 0.3s;
        }
        .control-row input[type="number"]:focus, .control-row select:focus {
            border-color: var(--primary-color); box-shadow: inset 0 0 0 1px var(--primary-color);
        }
        .dimensions-inputs { display: flex; align-items: center; gap: 10px; width: 100%; }
        #aspectLock {
            background: none; border: none; cursor: pointer; padding: 5px;
            font-size: 1.5em; color: var(--disabled-color); transition: color 0.3s;
        }
        #aspectLock.active { color: var(--primary-color); }
        #aspectLock:hover { color: var(--primary-hover); }

        .info-row { font-size: 0.85em; color: #777; text-align: center; margin-top: 5px; }
        #originalDimensions, #newDimensions { font-weight: bold; direction: ltr; display: inline-block; }

        #percentValue, #qualityValue {
            cursor: pointer; min-width: 60px; text-align: center; padding: 8px 0;
            border-radius: 4px; transition: background-color 0.2s;
        }
        #percentValue:hover, #qualityValue:hover { background-color: #f0f0f0; }
        #percentInput, #qualityInput { width: 65px; text-align: center; -moz-appearance: textfield; }
        #percentInput::-webkit-outer-spin-button, #percentInput::-webkit-inner-spin-button,
        #qualityInput::-webkit-outer-spin-button, #qualityInput::-webkit-inner-spin-button {
            -webkit-appearance: none; margin: 0;
        }
        
        #actionsContainer { margin-top: 25px; display: flex; gap: 10px; }
        .action-btn {
            flex: 1; color: white; padding: 0; height: 44px; line-height: 44px;
            border-radius: 8px; cursor: pointer; font-weight: bold; border: none;
            transition: background-color 0.3s, opacity 0.3s;
            font-size: 1.1em; text-align: center; position: relative;
        }
        .action-btn:disabled { background-color: var(--disabled-color); cursor: not-allowed; }
        .action-btn .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 3px solid #fff;
            width: 20px; height: 20px; animation: spin 1s linear infinite;
            position: absolute; left: 15px; top: 50%; margin-top: -10px; display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .action-btn.loading .spinner { display: block; }
        .action-btn.loading .btn-text { opacity: 0.7; }

        .action-btn.primary { background-color: var(--primary-color); }
        .action-btn.primary:hover:not(:disabled) { background-color: var(--primary-hover); }
        .action-btn.secondary { background-color: var(--secondary-color); }
        .action-btn.secondary:hover:not(:disabled) { background-color: var(--secondary-hover); }
        
        .hidden { display: none !important; }

        #infoButton {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background-color: rgba(44, 62, 80, 0.6); color: white;
            border: 1px solid rgba(255, 255, 255, 0.7); border-radius: 50%;
            width: 32px; height: 32px; font-size: 18px; font-weight: bold;
            line-height: 30px; text-align: center; cursor: pointer;
            transition: all 0.2s ease; opacity: 0; pointer-events: none;
        }
        #infoButton.visible { opacity: 1; pointer-events: auto; }
        #infoButton:hover { background-color: rgba(44, 62, 80, 0.9); transform: translate(-50%, -50%) scale(1.1); }
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6);
            justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: #fefefe; margin: auto; padding: 20px 30px;
            border: 1px solid #888; width: 80%; max-width: 450px;
            border-radius: 10px; position: relative; text-align: right; animation: fadeIn 0.3s;
        }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .close-button {
            color: #aaa; position: absolute; left: 15px; top: 10px;
            font-size: 28px; font-weight: bold; cursor: pointer;
        }
        .close-button:hover, .close-button:focus { color: black; text-decoration: none; }
        .modal-content h2 { margin-top: 0; color: var(--secondary-color); }
        .modal-content p { line-height: 1.6; font-size: 1.1em; }
        .modal-content p strong { color: var(--primary-color); }

        .site-footer { margin-top: auto; padding: 30px; color: #888; font-size: 0.9em; }
        .site-footer a { color: var(--primary-color); text-decoration: none; font-weight: bold; }
        .site-footer a:hover { text-decoration: underline; }

        @media (max-width: 768px) {
            .container { padding: 20px; }
            .controls-layout { flex-direction: column; }
            #controlsContainerSingle, #controlsContainerBatch { flex-direction: column; gap: 15px; }
        }

        /* --- START: Custom Select Arrow Styling --- */
        .custom-select-wrapper {
            position: relative;
            width: 100%;
        }
        .custom-select-wrapper select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            padding-left: 35px; /* Space for the custom arrow */
            background-color: #fff;
            cursor: pointer;
        }
        .custom-select-wrapper::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 12px;
            transform: translateY(-50%);
            width: 10px;
            height: 10px;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20292.4%20292.4%22%3E%3Cpath%20fill%3D%22%2334495e%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain;
            pointer-events: none;
            transition: transform 0.2s ease;
        }
        /* --- END: Custom Select Arrow Styling --- */
    </style>
</head>
<body>

    <div class="container">
        <h1>ŸÖÿ≠ŸàŸÑ <span>Ÿà</span>ŸÖÿ≠ÿ±ÿ± ÿßŸÑÿµŸàÿ±</h1>

        <label for="fileInput" id="uploadArea">
            <p class="primary-text">ÿßÿ∂ÿ∫ÿ∑ ŸáŸÜÿß ŸÑÿ±ŸÅÿπ ÿßŸÑÿµŸàÿ±</p>
            <p class="secondary-text">ÿ£Ÿà ŸÇŸÖ ÿ®ÿ≥ÿ≠ÿ® Ÿàÿ•ŸÅŸÑÿßÿ™ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ŸÅŸä Ÿáÿ∞Ÿá ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©</p>
            <span class="upload-button">ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÑŸÅÿßÿ™</span>
        </label>
        <input type="file" id="fileInput" accept="image/png, image/jpeg, image/webp, image/bmp, .heic, image/heic" multiple>

        <div id="imageEditor">
            <!-- === SINGLE FILE EDITOR VIEW === -->
            <div id="singleEditorView">
                <div id="previewContainer">
                    <img id="previewImage" src="" alt="ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑÿµŸàÿ±ÿ©">
                    <button id="infoButton" title="ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿµŸàÿ±ÿ©">i</button>
                </div>
                <div id="controlsContainerSingle" class="controls-layout">
                     <div class="control-group">
                        <h3>ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿ£ÿ®ÿπÿßÿØ</h3>
                        <div class="control-row">
                            <label for="percentSlider">ÿßŸÑŸÜÿ≥ÿ®ÿ©:</label>
                            <input type="range" id="percentSlider" min="1" max="400" value="100" style="width: 100%;">
                            <span id="percentValue">100%</span>
                            <input type="number" id="percentInput" value="100" min="1" max="400" class="hidden">
                        </div>
                        <div class="control-row">
                            <label>ÿßŸÑÿ£ÿ®ÿπÿßÿØ:</label>
                            <div class="dimensions-inputs">
                                <input type="number" id="widthInput" min="1" placeholder="ÿßŸÑÿπÿ±ÿ∂">
                                <button id="aspectLock" class="active" title="ŸÇŸÅŸÑ ŸÜÿ≥ÿ®ÿ© ÿßŸÑÿπÿ±ÿ∂ ÿ•ŸÑŸâ ÿßŸÑÿßÿ±ÿ™ŸÅÿßÿπ">üîí</button>
                                <input type="number" id="heightInput" min="1" placeholder="ÿßŸÑÿßÿ±ÿ™ŸÅÿßÿπ">
                            </div>
                        </div>
                         <div class="info-row">ÿßŸÑÿ£ÿ®ÿπÿßÿØ ÿßŸÑÿ£ÿµŸÑŸäÿ©: <span id="originalDimensions"></span></div>
                        <div class="info-row">ÿßŸÑÿ£ÿ®ÿπÿßÿØ ÿßŸÑÿ¨ÿØŸäÿØÿ©: <span id="newDimensions"></span></div>
                    </div>
                    <div class="control-group">
                        <h3>ÿßŸÑÿµŸäÿ∫ÿ© ŸàÿßŸÑÿ¨ŸàÿØÿ©</h3>
                        <!-- MODIFIED: Added wrapper class -->
                        <div class="control-row custom-select-wrapper">
                            <label for="formatSelect">ÿ™ÿ≠ŸàŸäŸÑ ÿ•ŸÑŸâ:</label>
                            <select id="formatSelect">
                                <option value="jpeg">JPEG</option>
                                <option value="png">PNG</option>
                                <option value="webp">WEBP</option>
                            </select>
                        </div>
                        <div id="qualityControl">
                            <div class="control-row">
                                <label for="qualitySlider">ÿßŸÑÿ¨ŸàÿØÿ©:</label>
                                <input type="range" id="qualitySlider" min="1" max="100" value="90" style="width: 100%;">
                                <span id="qualityValue">90%</span>
                                <input type="number" id="qualityInput" value="90" min="1" max="100" class="hidden">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- === BATCH (MULTI-FILE) EDITOR VIEW === -->
            <div id="batchEditorView">
                <div id="fileListContainer"></div>
                <div id="controlsContainerBatch" class="controls-layout">
                    <!-- Controls are cloned from the single view by JS -->
                </div>
            </div>
            
            <div id="actionsContainer">
                <button id="downloadButton" class="action-btn primary">
                    <span class="spinner"></span><span class="btn-text">ÿ™ÿ≠ŸàŸäŸÑ Ÿàÿ™ŸÜÿ≤ŸäŸÑ</span>
                </button>
                <button id="resetButton" class="action-btn secondary">
                    <span class="btn-text">ÿ•ŸÑÿ∫ÿßÿ°</span>
                </button>
            </div>
        </div>
    </div>
    
    <div id="infoModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿµŸàÿ±ÿ©</h2>
            <p><strong>ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÑŸÅ:</strong> <span id="infoFilename"></span></p>
            <p><strong>ÿßŸÑÿ£ÿ®ÿπÿßÿØ ÿßŸÑÿ£ÿµŸÑŸäÿ©:</strong> <span id="infoDimensions"></span></p>
            <p><strong>ŸÜŸàÿπ ÿßŸÑŸÖŸÑŸÅ:</strong> <span id="infoType"></span></p>
            <p><strong>ÿ≠ÿ¨ŸÖ ÿßŸÑŸÖŸÑŸÅ:</strong> <span id="infoSize"></span></p>
        </div>
    </div>

    <footer class="site-footer">
        <p>ÿ™ŸÖ ÿßŸÑÿ™ÿ∑ŸàŸäÿ± ÿ®Ÿàÿßÿ≥ÿ∑ÿ© <a href="https://github.com/iofahmawi" target="_blank" rel="noopener noreferrer">iofahmawi</a></p>
    </footer>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Elements ---
        const pageTitle = document.querySelector('h1');
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const imageEditor = document.getElementById('imageEditor');
        const singleEditorView = document.getElementById('singleEditorView');
        const batchEditorView = document.getElementById('batchEditorView');
        const previewContainer = document.getElementById('previewContainer');
        const previewImage = document.getElementById('previewImage');
        const controlsContainerSingle = document.getElementById('controlsContainerSingle');
        const fileListContainer = document.getElementById('fileListContainer');
        const controlsContainerBatch = document.getElementById('controlsContainerBatch');
        const percentSlider = document.getElementById('percentSlider');
        const percentValue = document.getElementById('percentValue');
        const percentInput = document.getElementById('percentInput');
        const widthInput = document.getElementById('widthInput');
        const heightInput = document.getElementById('heightInput');
        const aspectLock = document.getElementById('aspectLock');
        const originalDimensions = document.getElementById('originalDimensions');
        const newDimensions = document.getElementById('newDimensions');
        const formatSelect = document.getElementById('formatSelect');
        const qualityControl = document.getElementById('qualityControl');
        const qualitySlider = document.getElementById('qualitySlider');
        const qualityValue = document.getElementById('qualityValue');
        const qualityInput = document.getElementById('qualityInput');
        const downloadButton = document.getElementById('downloadButton');
        const resetButton = document.getElementById('resetButton');
        const infoButton = document.getElementById('infoButton');
        const infoModal = document.getElementById('infoModal');
        const closeButton = document.querySelector('.close-button');
        const infoFilename = document.getElementById('infoFilename');
        const infoDimensions = document.getElementById('infoDimensions');
        const infoType = document.getElementById('infoType');
        const infoSize = document.getElementById('infoSize');

        // --- App State ---
        let currentMode = null;
        let singleFileData = {};
        let batchFilesData = [];
        
        // --- CONSTANTS ---
        const MEMORY_LIMIT_BYTES = 256 * 1024 * 1024; // 256 MB

        // --- CLONE CONTROLS FOR BATCH MODE ---
        const batchControlsContent = controlsContainerSingle.cloneNode(true);
        batchControlsContent.querySelector('.dimensions-inputs').parentElement.remove();
        batchControlsContent.querySelectorAll('.info-row').forEach(el => el.remove());
        controlsContainerBatch.appendChild(batchControlsContent);
        
        const batchPercentSlider = controlsContainerBatch.querySelector('#percentSlider');
        const batchPercentValue = controlsContainerBatch.querySelector('#percentValue');
        const batchPercentInput = controlsContainerBatch.querySelector('#percentInput');
        const batchFormatSelect = controlsContainerBatch.querySelector('#formatSelect');
        const batchQualityControl = controlsContainerBatch.querySelector('#qualityControl');
        const batchQualitySlider = controlsContainerBatch.querySelector('#qualitySlider');
        const batchQualityValue = controlsContainerBatch.querySelector('#qualityValue');
        const batchQualityInput = controlsContainerBatch.querySelector('#qualityInput');

        // --- Generic Functions ---
        const showToast = (message) => alert(message);
        const formatBytes = (bytes, decimals = 2) => {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        };

        // --- File Handling & Mode Switching ---
        const handleFileDrop = (e) => { e.preventDefault(); e.stopPropagation(); uploadArea.classList.remove('dragging'); handleFiles(e.dataTransfer.files); };
        const handleFileInputChange = (e) => handleFiles(e.target.files);
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(ev => uploadArea.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); }));
        ['dragenter', 'dragover'].forEach(ev => uploadArea.addEventListener(ev, () => uploadArea.classList.add('dragging')));
        ['dragleave', 'drop'].forEach(ev => uploadArea.addEventListener(ev, () => uploadArea.classList.remove('dragging')));
        uploadArea.addEventListener('drop', handleFileDrop);
        fileInput.addEventListener('change', handleFileInputChange);

        function handleFiles(files) {
            if (!files.length) return;
            const imageFiles = Array.from(files).filter(f => f.type.startsWith('image/') || f.name.toLowerCase().endsWith('.heic'));
            if (!imageFiles.length) { showToast('ŸÑŸÖ Ÿäÿ™ŸÖ ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÑŸÅÿßÿ™ ÿµŸàÿ± ÿµÿßŸÑÿ≠ÿ©.'); return; }
            
            pageTitle.style.display = 'none';
            uploadArea.style.display = 'none';
            imageEditor.style.display = 'block';

            if (imageFiles.length === 1) {
                currentMode = 'single';
                setupSingleFileEditor(imageFiles[0]);
            } else {
                currentMode = 'batch';
                setupBatchEditor(imageFiles);
            }
        }
        
        function setupSingleFileEditor(file) {
            batchEditorView.style.display = 'none';
            singleEditorView.style.display = 'block';
            downloadButton.querySelector('.btn-text').textContent = 'ÿ™ÿ≠ŸàŸäŸÑ Ÿàÿ™ŸÜÿ≤ŸäŸÑ';
            resetButton.querySelector('.btn-text').textContent = 'ÿ±ŸÅÿπ ÿµŸàÿ±ÿ© ÿ¨ÿØŸäÿØÿ©';

            const process = (dataUrl) => {
                const img = new Image();
                img.onload = () => {
                    singleFileData.originalImage = img;
                    singleFileData.originalWidth = img.width;
                    singleFileData.originalHeight = img.height;
                    singleFileData.aspectRatio = img.width / img.height;
                    resetSingleControls();
                    previewImage.src = dataUrl;
                };
                img.onerror = () => {
                     showToast('ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸàÿ±ÿ©ÿå ŸÇÿØ ŸäŸÉŸàŸÜ ÿßŸÑŸÖŸÑŸÅ ÿ™ÿßŸÑŸÅŸãÿß.');
                     resetApp();
                }
                img.src = dataUrl;
            };

            singleFileData = { name: file.name, type: file.type, size: file.size };

            if (file.type === 'image/heic' || file.name.toLowerCase().endsWith('.heic')) {
                showToast('Ÿäÿ™ŸÖ ÿ™ÿ≠ŸàŸäŸÑ ÿµŸàÿ±ÿ© HEICÿå Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±...');
                heic2any({ blob: file, toType: "image/jpeg", quality: 0.9 })
                    .then(res => {
                        const reader = new FileReader();
                        reader.onload = e => process(e.target.result);
                        reader.readAsDataURL(res);
                    }).catch(err => { console.error(err); showToast('ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸàŸäŸÑ HEIC.'); resetApp(); });
            } else {
                const reader = new FileReader();
                reader.onload = e => process(e.target.result);
                reader.readAsDataURL(file);
            }
        }

        function resetSingleControls() {
            const { originalWidth, originalHeight } = singleFileData;
            percentSlider.value = 100;
            percentValue.textContent = '100%';
            widthInput.value = originalWidth;
            heightInput.value = originalHeight;
            singleFileData.currentWidth = originalWidth;
            singleFileData.currentHeight = originalHeight;
            
            originalDimensions.textContent = `${originalWidth}x${originalHeight}`;
            updateNewDimensionsDisplay();
            
            singleFileData.isRatioLocked = true;
            aspectLock.classList.add('active');
            aspectLock.textContent = 'üîí';
            
            formatSelect.value = 'jpeg';
            qualitySlider.value = 90;
            qualityValue.textContent = '90%';
            toggleQualitySlider(formatSelect, qualityControl);
        }

        function updateNewDimensionsDisplay() {
            newDimensions.textContent = `${singleFileData.currentWidth}x${singleFileData.currentHeight}`;
        }

        widthInput.addEventListener('input', () => {
            let newWidth = parseInt(widthInput.value) || 0;
            if (newWidth <= 0) return;
            singleFileData.currentWidth = newWidth;
            if (singleFileData.isRatioLocked) {
                singleFileData.currentHeight = Math.round(newWidth / singleFileData.aspectRatio);
                heightInput.value = singleFileData.currentHeight;
            } else {
                singleFileData.currentHeight = parseInt(heightInput.value) || singleFileData.currentHeight;
            }
            updateSliderFromDimensions();
            updateNewDimensionsDisplay();
        });
            
        heightInput.addEventListener('input', () => {
            let newHeight = parseInt(heightInput.value) || 0;
            if (newHeight <= 0) return;
            singleFileData.currentHeight = newHeight;
            if (singleFileData.isRatioLocked) {
                singleFileData.currentWidth = Math.round(newHeight * singleFileData.aspectRatio);
                widthInput.value = singleFileData.currentWidth;
            } else {
                singleFileData.currentWidth = parseInt(widthInput.value) || singleFileData.currentWidth;
            }
            updateSliderFromDimensions();
            updateNewDimensionsDisplay();
        });
        
        function updateSliderFromDimensions() {
            const percent = Math.round((singleFileData.currentWidth / singleFileData.originalWidth) * 100);
            const clamped = Math.min(Math.max(percent, 1), 400);
            percentSlider.value = clamped;
            percentValue.textContent = `${clamped}%`;
        }

        aspectLock.addEventListener('click', () => {
            singleFileData.isRatioLocked = !singleFileData.isRatioLocked;
            aspectLock.classList.toggle('active', singleFileData.isRatioLocked);
            aspectLock.textContent = singleFileData.isRatioLocked ? 'üîí' : 'üîì';
            if(singleFileData.isRatioLocked) { widthInput.dispatchEvent(new Event('input')); }
        });


        async function setupBatchEditor(files) {
            singleEditorView.style.display = 'none';
            batchEditorView.style.display = 'block';
            downloadButton.querySelector('.btn-text').textContent = `ÿ™ÿ≠ŸàŸäŸÑ Ÿàÿ™ŸÜÿ≤ŸäŸÑ (${files.length}) ŸÖŸÑŸÅÿßÿ™`;
            resetButton.querySelector('.btn-text').textContent = 'ŸÖÿ≥ÿ≠ ÿßŸÑŸÉŸÑ';
            fileListContainer.innerHTML = '<h4>ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸàÿ±...</h4>';
            
            const filePromises = files.map(file => new Promise((resolve, reject) => {
                const process = (dataUrl) => {
                    const img = new Image();
                    img.onload = () => resolve({ name: file.name, dataUrl, imageElement: img });
                    img.onerror = reject;
                    img.src = dataUrl;
                };
                 if (file.type === 'image/heic' || file.name.toLowerCase().endsWith('.heic')) {
                    heic2any({ blob: file, toType: "image/jpeg" })
                        .then(res => {
                            const reader = new FileReader();
                            reader.onload = e => process(e.target.result);
                            reader.readAsDataURL(res);
                        }).catch(reject);
                } else {
                    const reader = new FileReader();
                    reader.onload = e => process(e.target.result);
                    reader.readAsDataURL(file);
                }
            }));

            try {
                batchFilesData = await Promise.all(filePromises);
                renderFileList();
            } catch (err) {
                console.error("Error processing files:", err);
                showToast('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ŸÖÿπÿßŸÑÿ¨ÿ© ÿ®ÿπÿ∂ ÿßŸÑŸÖŸÑŸÅÿßÿ™.');
                resetApp();
            }
        }
        
        function renderFileList() {
            fileListContainer.innerHTML = '';
            batchFilesData.forEach(file => {
                const item = document.createElement('div');
                item.className = 'file-item';
                item.innerHTML = `<img src="${file.dataUrl}" alt="${file.name}"><p class="file-item-name">${file.name}</p>`;
                fileListContainer.appendChild(item);
            });
        }


        const initSharedControls = (slider, val, input, format, qControl) => {
            slider.addEventListener('input', () => val.textContent = `${slider.value}%`);
            val.addEventListener('click', () => {
                val.classList.add('hidden'); input.classList.remove('hidden');
                input.value = slider.value; input.focus(); input.select();
            });
            const updateFromInput = () => {
                val.classList.remove('hidden'); input.classList.add('hidden');
                let p = parseInt(input.value, 10);
                if (isNaN(p) || p < 1) p = 1;
                if (p > parseInt(slider.max, 10)) p = parseInt(slider.max, 10);
                slider.value = p; slider.dispatchEvent(new Event('input'));
            };
            input.addEventListener('blur', updateFromInput);
            input.addEventListener('keydown', e => { if (e.key === 'Enter') input.blur(); });
            
            if (format) format.addEventListener('change', () => toggleQualitySlider(format, qControl));
        };

        const toggleQualitySlider = (formatEl, qualityEl) => {
            const isLossy = formatEl.value === 'jpeg' || formatEl.value === 'webp';
            qualityEl.classList.toggle('hidden', !isLossy);
        };

        initSharedControls(percentSlider, percentValue, percentInput);
        initSharedControls(qualitySlider, qualityValue, qualityInput, formatSelect, qualityControl);
        percentSlider.addEventListener('input', () => { 
            const percent = percentSlider.value;
            singleFileData.currentWidth = Math.round((singleFileData.originalWidth * percent) / 100);
            singleFileData.currentHeight = Math.round((singleFileData.originalHeight * percent) / 100);
            widthInput.value = singleFileData.currentWidth;
            heightInput.value = singleFileData.currentHeight;
            updateNewDimensionsDisplay();
        });

        initSharedControls(batchPercentSlider, batchPercentValue, batchPercentInput);
        initSharedControls(batchQualitySlider, batchQualityValue, batchQualityInput, batchFormatSelect, batchQualityControl);

        infoButton.addEventListener('click', (e) => {
            e.stopPropagation();
            const { name, originalWidth, originalHeight, type, size } = singleFileData;
            infoFilename.textContent = name;
            infoDimensions.textContent = `${originalWidth}x${originalHeight}`;
            infoType.textContent = type;
            infoSize.textContent = formatBytes(size);
            infoModal.style.display = 'flex';
        });
        previewContainer.addEventListener('click', () => infoButton.classList.add('visible'));
        closeButton.addEventListener('click', () => infoModal.style.display = 'none');
        window.addEventListener('click', (e) => {
            if (e.target === infoModal) infoModal.style.display = 'none';
            if (!previewContainer.contains(e.target)) infoButton.classList.remove('visible');
        });

        // --- ACTIONS (Download / Reset) ---
        downloadButton.addEventListener('click', () => {
            if (currentMode === 'single') downloadSingleFile();
            if (currentMode === 'batch') downloadBatchFiles();
        });
        
        // --- FINAL, ROBUST DOWNLOAD LOGIC ---

        function triggerDownload(dataUrl, fileName) {
            const link = document.createElement('a');
            link.download = fileName;
            link.href = dataUrl;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            if (dataUrl.startsWith('blob:')) {
                URL.revokeObjectURL(dataUrl);
            }
        }

        function getCanvasBlob(canvas, format, quality) {
            return new Promise((resolve, reject) => {
                try {
                    const mimeType = `image/${format}`;
                    switch(format) {
                        case 'jpeg':
                        case 'webp':
                            canvas.toBlob(resolve, mimeType, quality);
                            break;
                        case 'png':
                            canvas.toBlob(resolve, mimeType);
                            break;
                        default:
                            reject(new Error('Format not supported: ' + format));
                    }
                } catch(e) {
                    reject(e);
                }
            });
        }

        async function downloadSingleFile() {
            const { originalImage, currentWidth, currentHeight, name } = singleFileData;
            if (!originalImage || currentWidth <= 0 || currentHeight <= 0) return;
            
            const estimatedMemory = currentWidth * currentHeight * 4;
            if (estimatedMemory > MEMORY_LIMIT_BYTES) {
                showToast(`ŸÅÿ¥ŸÑ ÿßŸÑÿ™ÿ≠ŸàŸäŸÑ. ÿ£ÿ®ÿπÿßÿØ ÿßŸÑÿµŸàÿ±ÿ© (${currentWidth}x${currentHeight}) ŸÉÿ®Ÿäÿ±ÿ© ÿ¨ÿØŸãÿß Ÿàÿ™ÿ™ÿ∑ŸÑÿ® ÿ∞ÿßŸÉÿ±ÿ© ÿ™ŸÅŸàŸÇ ÿßŸÑÿ≠ÿØ ÿßŸÑŸÖÿ≥ŸÖŸàÿ≠ ÿ®Ÿá (${formatBytes(MEMORY_LIMIT_BYTES)}). Ÿäÿ±ÿ¨Ÿâ ÿ™ŸÇŸÑŸäŸÑ ÿßŸÑÿ£ÿ®ÿπÿßÿØ ŸàÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.`);
                return;
            }

            setDownloadButtonLoading(true);

            const canvas = document.createElement('canvas');
            canvas.width = currentWidth;
            canvas.height = currentHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(originalImage, 0, 0, currentWidth, currentHeight);
            
            const format = formatSelect.value;
            const quality = parseInt(qualitySlider.value) / 100;
            const baseFileName = name.split('.').slice(0, -1).join('.') || name;
            const newFileName = `${baseFileName}_${currentWidth}x${currentHeight}.${format}`;

            try {
                const blob = await getCanvasBlob(canvas, format, quality);
                 if (!blob) throw new Error("ŸÅÿ¥ŸÑ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÖŸÑŸÅ (blob).");
                const objectUrl = URL.createObjectURL(blob);
                triggerDownload(objectUrl, newFileName);
            } catch (e) {
                console.error("Download failed:", e);
                showToast(`ŸÅÿ¥ŸÑ ÿßŸÑÿ™ÿ≠ŸàŸäŸÑ: ${e.message}. ŸÇÿØ ŸäŸÉŸàŸÜ ÿßŸÑÿ≥ÿ®ÿ® ŸáŸà ÿ∂ÿ∫ÿ∑ ÿßŸÑÿ∞ÿßŸÉÿ±ÿ© ŸÅŸä ÿßŸÑŸÖÿ™ÿµŸÅÿ≠.`);
            } finally {
                setDownloadButtonLoading(false);
            }
        }
        
        async function downloadBatchFiles() {
            if (!batchFilesData.length) return;
            setDownloadButtonLoading(true);

            const zip = new JSZip();
            const format = batchFormatSelect.value;
            const quality = parseInt(batchQualitySlider.value, 10) / 100;
            const percent = parseInt(batchPercentSlider.value, 10) / 100;
            let skippedFiles = 0;

            const processingPromises = batchFilesData.map(async (fileData) => {
                const img = fileData.imageElement;
                const newWidth = Math.round(img.width * percent);
                const newHeight = Math.round(img.height * percent);
                
                const estimatedMemory = newWidth * newHeight * 4;
                if (estimatedMemory > MEMORY_LIMIT_BYTES) {
                    console.warn(`Skipping file ${fileData.name} due to large dimensions.`);
                    skippedFiles++;
                    return;
                }

                const canvas = document.createElement('canvas');
                canvas.width = newWidth > 0 ? newWidth : 1;
                canvas.height = newHeight > 0 ? newHeight : 1;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                try {
                    const blob = await getCanvasBlob(canvas, format, quality);
                    if (!blob) throw new Error("Blob creation failed.");
                    const baseFileName = fileData.name.split('.').slice(0, -1).join('.') || fileData.name;
                    const newFileName = `${baseFileName}_${newWidth}x${newHeight}.${format}`;
                    zip.file(newFileName, blob);
                } catch(e) {
                    console.error('Failed to process file:', fileData.name, e);
                    skippedFiles++;
                }
            });

            try {
                await Promise.all(processingPromises);

                if (skippedFiles > 0) {
                    showToast(`ÿ™ŸÖ ÿ™ÿÆÿ∑Ÿä ${skippedFiles} ŸÖŸÑŸÅ ÿ®ÿ≥ÿ®ÿ® ÿ≠ÿ¨ŸÖ ÿ£ÿ®ÿπÿßÿØŸáÿß ÿßŸÑŸÉÿ®Ÿäÿ± ÿ¨ÿØŸãÿß.`);
                }
                
                const zipContent = await zip.generateAsync({ type: "blob" });
                if (zipContent.size > 0) {
                    triggerDownload(URL.createObjectURL(zipContent), `converted_images_${Date.now()}.zip`);
                } else if (skippedFiles === batchFilesData.length) {
                    showToast("ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ≠ŸàŸäŸÑ ÿ£Ÿä ŸÖŸÑŸÅÿßÿ™ ŸÑÿ£ŸÜ ÿ¨ŸÖŸäÿπŸáÿß ŸÉÿßŸÜÿ™ ÿ∞ÿßÿ™ ÿ£ÿ®ÿπÿßÿØ ŸÉÿ®Ÿäÿ±ÿ© ÿ¨ÿØŸãÿß.");
                } else if (batchFilesData.length > 0 && skippedFiles < batchFilesData.length) {
                     showToast("ŸÅÿ¥ŸÑ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÖŸÑŸÅ ÿßŸÑŸÖÿ∂ÿ∫Ÿàÿ∑ ÿ®ÿßŸÑÿ±ÿ∫ŸÖ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ŸÖŸÑŸÅÿßÿ™ ÿµÿßŸÑÿ≠ÿ©.");
                }

            } catch (err) {
                console.error("Error creating zip file:", err); 
                showToast('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÖŸÑŸÅ ÿßŸÑŸÖÿ∂ÿ∫Ÿàÿ∑.');
            } finally { 
                setDownloadButtonLoading(false); 
            }
        }

        const setDownloadButtonLoading = (isLoading) => {
            downloadButton.classList.toggle('loading', isLoading);
            downloadButton.disabled = isLoading;
            resetButton.disabled = isLoading;
        };

        const resetApp = () => {
            imageEditor.style.display = 'none';
            singleEditorView.style.display = 'none';
            batchEditorView.style.display = 'none';
            uploadArea.style.display = 'flex';
            pageTitle.style.display = 'block';
            fileInput.value = '';
            infoButton.classList.remove('visible');
            singleFileData = {};
            batchFilesData = [];
        };

        resetButton.addEventListener('click', resetApp);
    });
    </script>
    <script>
    if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('sw.js').then(registration => { console.log('SW registration successful:', registration.scope); }).catch(err => { console.log('SW registration failed:', err); }); }); }
  </script>
</body>

</html>
