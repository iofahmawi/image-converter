<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>محرر الصور السريع</title>
    
    <!-- === PWA Additions === -->
    <meta name="theme-color" content="#f4f7f9">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon-1440.png">
    <link rel="apple-touch-icon" href="icon-1440.png">
    <!-- ============================= -->
    
    <!-- === Google Fonts (Cairo) === -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- ============================== -->
    
    <!-- === Cropper.js (أداة القص) === -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

    <!-- Library to handle HEIC files -->
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
    <!-- Library to create ZIP files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <style>
        :root {
            --primary-color: #e67e22; --primary-hover: #d35400;
            --secondary-color: #34495e; --secondary-hover: #2c3e50;
            --background-color: #f4f7f9; --container-bg-color: #ffffff;
            --text-color: #333; --text-light-color: #ffffff;
            --border-color: #e0e0e0; --disabled-color: #bdc3c7;
        }

        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }

        html {
            height: 100%;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--background-color); color: var(--text-color);
            margin: 0;
            padding: 25px 25px 5px;
            direction: rtl;
            display: flex;
            flex-direction: column;
            min-height: 100%;
            font-size: 16px;
            align-items: center; 
        }
        
        button, input, select { font-family: inherit; }

        .container {
            width: 98%; max-width: 900px; background: var(--container-bg-color);
            padding: 40px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.07);
            text-align: center;
            margin-bottom: 40px;
        }

        h1 {
            color: var(--text-color); 
            margin: 0 0 24px 0; 
            font-weight: 700; 
            font-size: 1.8em; 
        }
       
        #uploadArea {
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 40px 20px; border: 2px dashed #d0dbe2; border-radius: 12px;
            cursor: pointer; transition: border-color 0.3s, background-color 0.3s;
        }
        #uploadArea.dragging, #uploadArea:hover {
            border-color: var(--primary-color); background-color: #fffaf5;
        }
        #uploadArea .primary-text { font-size: 1.11em; font-weight: 600; margin: 0 0 10px 0; }
        #uploadArea .secondary-text { font-size: 0.95em; color: #777; margin: 0 0 25px 0; }
        .upload-button {
            background-color: var(--primary-color); color: var(--text-light-color);
            height: 44px; line-height: 44px; padding: 0 35px; border-radius: 8px;
            font-weight: 700; display: inline-block; transition: background-color 0.3s;
            border: none;
            font-size: 1em;
        }
        #uploadArea:hover .upload-button { background-color: var(--primary-hover); }
        #fileInput { display: none; }

        #imageEditor { display: none; text-align: right; }
        
        #singleEditorView { display: none; }
        #previewContainer {
            background-color: #f9f9f9; border: 1px solid var(--border-color);
            border-radius: 8px; display: flex; justify-content: center; align-items: center;
            padding: 15px; min-height: 350px; position: relative; margin-bottom: 30px;
            overflow: hidden;
        }
        #previewImage {
            max-width: 100%; max-height: 450px; object-fit: contain;
            border-radius: 4px;
            transition: transform 0.3s ease;
        }
        
        #cropperContainer {
            margin-bottom: 20px;
            max-height: 60vh; 
        }
        #cropperImage {
            display: block;
            max-width: 100%;
        }

        .controls-layout { display: flex; gap: 30px; }
        #controlsContainerSingle {
             display: flex; gap: 20px; flex-wrap: wrap; width: 100%;
        }
        .control-group {
            border: 1px solid var(--border-color); padding: 15px;
            border-radius: 8px; flex: 1; min-width: 280px;
        }
        .control-group h3 {
            text-align: center; margin: 0 0 15px 0;
            font-weight: 700;
            padding-bottom: 10px; color: var(--secondary-color);
            font-size: 1.1em;
        }
        .control-row { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .control-row label { flex-basis: 70px; flex-shrink: 0; font-weight: 700; font-size: 1em; }
        .control-row input[type="number"], .control-row select {
            width: 100%; padding: 9px 10px; border-radius: 4px; border: 1px solid var(--border-color);
            outline: none; transition: border-color 0.3s, box-shadow 0.3s;
            font-size: 1em;
        }
        
        /* --- START: Dropdown arrow fix --- */
        .control-row select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%2334495e'%3E%3Cpath d='M8 11.207l-4.604-4.604.707-.707L8 9.793l3.896-3.897.707.707z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: left 10px center;
            background-size: 16px;
            padding: 9px 10px 9px 35px;
        }
        /* --- END: Dropdown arrow fix --- */

        .control-row input[type="number"]:focus, .control-row select:focus {
            border-color: var(--primary-color); box-shadow: inset 0 0 0 1px var(--primary-color);
        }
        .dimensions-inputs { display: flex; align-items: center; gap: 10px; width: 100%; }
        #aspectLock {
            background: none; border: none; cursor: pointer; padding: 5px;
            font-size: 1.5em; color: var(--primary-color); /* اللون البرتقالي الدائم */
            display: flex; align-items: center; justify-content: center;
        }

        .info-row { font-size: 0.9em; color: #777; text-align: center; margin-top: 5px; }
        #originalDimensions, #newDimensions { font-weight: bold; direction: ltr; display: inline-block; }

        #percentValue, #qualityValue {
            cursor: pointer;
            min-width: 60px;
            text-align: center;
            padding: 8px 0;
            border-radius: 4px;
            transition: background-color 0.2s, color 0.2s;
            font-size: 1em;
            font-weight: 700; /* لجعل الخط سميكًا */
        }
        
        .transform-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .transform-btn {
            background-color: #ecf0f1;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.2em;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.2s, color 0.2s;
        }
        .transform-btn:hover {
            background-color: var(--secondary-color);
            color: white;
        }
        .transform-btn svg {
            width: 22px;
            height: 22px;
            fill: var(--secondary-color);
            transition: fill 0.2s;
        }
        #aspectLock svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
            vertical-align: middle;
        }
        .transform-btn:hover svg {
            fill: white;
        }
        #crop-mode-btn { width: auto; padding: 0 15px; font-size: 1em; }

        #actionsContainer, #cropActions { margin-top: 25px; display: flex; gap: 10px; justify-content: center; }
        .action-btn {
            flex: 1; color: white; padding: 0; height: 44px; line-height: 44px;
            border-radius: 8px; cursor: pointer; font-weight: 700; border: none;
            transition: background-color 0.3s, opacity 0.3s;
            text-align: center; position: relative;
            font-size: 1em;
        }
        
        #cropActions .action-btn {
            flex: none;
            width: auto;
            padding: 0 30px;
        }
        
        .action-btn:disabled { background-color: var(--disabled-color); cursor: not-allowed; }
        
        .action-btn .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 3px solid #fff;
            width: 20px; height: 20px; animation: spin 1s linear infinite;
            position: absolute; left: 15px; top: 50%; margin-top: -10px; display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .action-btn.loading .spinner { display: block; }
        .action-btn.loading .btn-text { opacity: 0.7; }

        .action-btn.primary { background-color: var(--primary-color); }
        .action-btn.primary:hover:not(:disabled) { background-color: var(--primary-hover); }
        .action-btn.secondary { background-color: var(--secondary-color); }
        .action-btn.secondary:hover:not(:disabled) { background-color: var(--secondary-hover); }
        
        .hidden { display: none !important; }

        .site-footer { 
            margin-top: auto; 
            padding-top: 0; 
            text-align: center;
            color: #888; 
            font-size: 0.9em;
            width: 100%;
        }
        .site-footer a { color: var(--primary-color); text-decoration: none; font-weight: bold; font-size: 1.1em; }
        .site-footer a:hover { text-decoration: underline; }

        @media (max-width: 768px) {
            body { 
                font-size: 15px; 
                padding-left: 10px;
                padding-right: 10px;
            }
            .container { 
                padding: 20px; 
                margin-bottom: 30px;
            }
            .controls-layout { flex-direction: column; }
            #controlsContainerSingle { flex-direction: column; gap: 15px; }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>محرر الصور السريع</h1>

        <label for="fileInput" id="uploadArea">
            <p class="primary-text">اضغط هنا لرفع الصور</p>
            <p class="secondary-text">أو قم بسحب وإفلات الملفات في هذه المنطقة</p>
            <span class="upload-button">اختيار ملفات</span>
        </label>
        <input type="file" id="fileInput" accept="image/png, image/jpeg, image/webp, image/bmp, .heic, image/heic">

        <div id="imageEditor">
            <div id="singleEditorView">
                
                <div id="cropperView" class="hidden">
                    <div id="cropperContainer">
                        <img id="cropperImage">
                    </div>
                    <div id="cropActions">
                        <button id="confirmCropBtn" class="action-btn primary">تأكيد القص</button>
                        <button id="cancelCropBtn" class="action-btn secondary">إلغاء</button>
                    </div>
                </div>

                <div id="editorView">
                    <div id="previewContainer">
                        <img id="previewImage" src="">
                    </div>

                    <div id="controlsContainerSingle" class="controls-layout">
                        <div class="control-group">
                            <h3>تحرير أساسي</h3>
                            <div class="control-row">
                                <div class="transform-buttons" style="width: 100%;">
                                    <button class="transform-btn" id="rotate-left" title="تدوير لليسار">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M8 3a5 5 0 1 1-4.546 2.914.5.5 0 0 0-.908-.417A6 6 0 1 0 8 2v1z M8 4.466V.534a.25.25 0 0 0-.41-.192L5.23 2.308a.25.25 0 0 0 0 .384l2.36 1.966A.25.25 0 0 0 8 4.466z"/></svg>
                                    </button>
                                    <button class="transform-btn" id="rotate-right" title="تدوير لليمين">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/></svg>
                                    </button>
                                    <button class="transform-btn" id="flip-h" title="قلب أفقي">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 12l-4-4v3H7v-3l-4 4 4 4v-3h10v3z"/></svg>
                                    </button>
                                    <button class="transform-btn" id="flip-v" title="قلب عمودي">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 21l-4-4h3V7H8l4-4 4 4h-3v10h3l-4 4z"/></svg>
                                    </button>
                                    <button class="transform-btn" id="crop-mode-btn" title="قص الصورة">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 15h2V7c0-1.1-.9-2-2-2H9v2h8v8zM7 17V1H5v4H1v2h4v10c0 1.1.9 2 2 2h10v4h2v-4h4v-2H7z"/></svg>
                                    </button>
                                </div>
                            </div>
                        </div>

                         <div class="control-group">
                            <h3>تغيير الأبعاد</h3>
                            <div class="control-row">
                                <label for="percentSlider">النسبة:</label>
                                <input type="range" id="percentSlider" min="1" max="400" value="100" style="width: 100%;">
                                <span id="percentValue">100%</span>
                            </div>
                            <div class="control-row">
                                <label>الأبعاد:</label>
                                <div class="dimensions-inputs">
                                    <input type="number" id="widthInput" min="1" placeholder="العرض">
                                    <button id="aspectLock" title="قفل نسبة العرض إلى الارتفاع">
                                        <svg class="lock-icon-closed" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM9 6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9V6zm9 14H6V10h12v10zm-6-3c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2z"/></svg>
                                        <svg class="lock-icon-open" style="display:none;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6h2c0-1.66 1.34-3 3-3s3 1.34 3 3v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm0 12H6V10h12v10zm-6-3c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2z"/></svg>
                                    </button>
                                    <input type="number" id="heightInput" min="1" placeholder="الارتفاع">
                                </div>
                            </div>
                             <div class="info-row">الأبعاد الأصلية: <span id="originalDimensions"></span></div>
                            <div class="info-row">الأبعاد الجديدة: <span id="newDimensions"></span></div>
                        </div>
                        <div class="control-group">
                            <h3>الصيغة والجودة</h3>
                            <div class="control-row">
                                <label for="formatSelect">تحويل إلى:</label>
                                <select id="formatSelect" class="custom-select-wrapper">
                                    <option value="jpeg">JPEG</option>
                                    <option value="webp">WEBP</option>
                                    <option value="png">PNG</option>
                                </select>
                            </div>
                            <div id="qualityControl">
                                <div class="control-row">
                                    <label for="qualitySlider">الجودة:</label>
                                    <input type="range" id="qualitySlider" min="1" max="100" value="90" style="width: 100%;">
                                    <span id="qualityValue">90%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="actionsContainer">
                        <button id="downloadButton" class="action-btn primary">
                            <span class="spinner"></span><span class="btn-text">تحويل وتنزيل</span>
                        </button>
                        <button id="resetButton" class="action-btn secondary">
                            <span class="btn-text">إلغاء</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="site-footer">
        <p>طوّر بواسطة <a href="https://github.com/iofahmawi" target="_blank" rel="noopener noreferrer">iofahmawi</a></p>
    </footer>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Elements ---
        const pageTitle = document.querySelector('h1');
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const imageEditor = document.getElementById('imageEditor');
        const singleEditorView = document.getElementById('singleEditorView');
        
        const editorView = document.getElementById('editorView');
        const cropperView = document.getElementById('cropperView');
        const cropperImage = document.getElementById('cropperImage');
        const cropModeBtn = document.getElementById('crop-mode-btn');
        const confirmCropBtn = document.getElementById('confirmCropBtn');
        const cancelCropBtn = document.getElementById('cancelCropBtn');

        const previewImage = document.getElementById('previewImage');
        const percentSlider = document.getElementById('percentSlider');
        const percentValue = document.getElementById('percentValue');
        const widthInput = document.getElementById('widthInput');
        const heightInput = document.getElementById('heightInput');
        const aspectLock = document.getElementById('aspectLock');
        const originalDimensions = document.getElementById('originalDimensions');
        const newDimensions = document.getElementById('newDimensions');
        const formatSelect = document.getElementById('formatSelect');
        const qualityControl = document.getElementById('qualityControl');
        const qualitySlider = document.getElementById('qualitySlider');
        const qualityValue = document.getElementById('qualityValue');
        const actionsContainer = document.getElementById('actionsContainer');
        const downloadButton = document.getElementById('downloadButton');
        const resetButton = document.getElementById('resetButton');
        const rotateLeftBtn = document.getElementById('rotate-left');
        const rotateRightBtn = document.getElementById('rotate-right');
        const flipHBtn = document.getElementById('flip-h');
        const flipVBtn = document.getElementById('flip-v');

        // --- App State ---
        let singleFileData = {};
        let cropper = null;
        let rotation = 0;
        let scaleH = 1;
        let scaleV = 1;
        
        const MEMORY_LIMIT_BYTES = 256 * 1024 * 1024;
        const showToast = (message) => alert(message);
        
        // --- File Handling ---
        const handleFileDrop = (e) => { e.preventDefault(); e.stopPropagation(); uploadArea.classList.remove('dragging'); handleFiles(e.dataTransfer.files); };
        const handleFileInputChange = (e) => handleFiles(e.target.files);
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(ev => uploadArea.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); }));
        ['dragenter', 'dragover'].forEach(ev => uploadArea.addEventListener(ev, () => uploadArea.classList.add('dragging')));
        ['dragleave', 'drop'].forEach(ev => uploadArea.addEventListener(ev, () => uploadArea.classList.remove('dragging')));
        uploadArea.addEventListener('drop', handleFileDrop);
        fileInput.addEventListener('change', handleFileInputChange);

        function handleFiles(files) {
            if (!files.length || files.length > 1) {
                showToast('يرجى رفع صورة واحدة فقط.');
                return;
            }
            
            const file = files[0];
            if (!file.type.startsWith('image/') && !file.name.toLowerCase().endsWith('.heic')) {
                showToast('يرجى اختيار ملف صورة صالح.');
                return;
            }

            pageTitle.style.display = 'none';
            uploadArea.style.display = 'none';
            imageEditor.style.display = 'block';
            setupSingleFileEditor(file);
        }
        
        function setupSingleFileEditor(file) {
            singleEditorView.style.display = 'block';

            const process = (dataUrl) => {
                const img = new Image();
                img.onload = () => updateEditorWithNewImage(img);
                img.src = dataUrl;
            };

            singleFileData.name = file.name;
            singleFileData.type = file.type || 'image/jpeg';

            if (file.type === 'image/heic' || file.name.toLowerCase().endsWith('.heic')) {
                showToast('يتم تحويل صورة HEIC، يرجى الانتظار...');
                heic2any({ blob: file, toType: "image/jpeg", quality: 0.9 })
                    .then(res => new Promise(resolve => {
                        const reader = new FileReader();
                        reader.onload = e => resolve(e.target.result);
                        reader.readAsDataURL(res);
                    }))
                    .then(process)
                    .catch(err => { console.error(err); showToast('فشل تحويل HEIC.'); resetApp(); });
            } else {
                const reader = new FileReader();
                reader.onload = e => process(e.target.result);
                reader.readAsDataURL(file);
            }
        }
        
        function updateEditorWithNewImage(image) {
            singleFileData.originalImage = image;
            singleFileData.originalWidth = image.width;
            singleFileData.originalHeight = image.height;
            singleFileData.aspectRatio = image.width / image.height;
            previewImage.src = image.src;
            resetSingleControls();
        }

        function resetSingleControls() {
            const { originalWidth, originalHeight } = singleFileData;
            percentSlider.value = 100;
            widthInput.value = originalWidth; heightInput.value = originalHeight;
            singleFileData.currentWidth = originalWidth; singleFileData.currentHeight = originalHeight;
            originalDimensions.textContent = `${originalWidth}x${originalHeight}`;
            updateNewDimensionsDisplay();
            singleFileData.isRatioLocked = true;
            aspectLock.querySelector('.lock-icon-closed').style.display = 'block';
            aspectLock.querySelector('.lock-icon-open').style.display = 'none';
            aspectLock.title = 'قفل نسبة العرض إلى الارتفاع';
            formatSelect.value = 'jpeg';
            toggleQualityControl(formatSelect, qualityControl);
            rotation = 0; scaleH = 1; scaleV = 1;
            updatePreviewTransform();
            percentSlider.dispatchEvent(new Event('input'));
            qualitySlider.dispatchEvent(new Event('input'));
        }
        
        // --- CROP MODE ---
        cropModeBtn.addEventListener('click', () => {
            editorView.classList.add('hidden');
            cropperView.classList.remove('hidden');
            
            cropperImage.src = singleFileData.originalImage.src;
            if(cropper) cropper.destroy();
            cropper = new Cropper(cropperImage, {
                viewMode: 1, background: false, autoCropArea: 0.9, responsive: true
            });
        });

        function exitCropMode() {
            if(cropper) cropper.destroy(); cropper = null;
            editorView.classList.remove('hidden');
            cropperView.classList.add('hidden');
        }
        cancelCropBtn.addEventListener('click', exitCropMode);

        confirmCropBtn.addEventListener('click', () => {
            if (!cropper) return;
            const croppedCanvas = cropper.getCroppedCanvas({
                imageSmoothingEnabled: true, imageSmoothingQuality: 'high',
            });
            if (!croppedCanvas) { showToast('فشل قص الصورة.'); return; }

            const dataUrl = croppedCanvas.toDataURL(singleFileData.type);
            const img = new Image();
            img.onload = () => {
                updateEditorWithNewImage(img);
                exitCropMode();
            };
            img.src = dataUrl;
        });

        // --- Other Controls ---
        function updateNewDimensionsDisplay() {
            const isSideways = rotation % 180 !== 0;
            const w = isSideways ? singleFileData.currentHeight : singleFileData.currentWidth;
            const h = isSideways ? singleFileData.currentWidth : singleFileData.currentHeight;
            newDimensions.textContent = `${w}x${h}`;
        }
        
        function updatePreviewTransform() {
            previewImage.style.transform = `rotate(${rotation}deg) scale(${scaleH}, ${scaleV})`;
            updateNewDimensionsDisplay();
        }

        rotateLeftBtn.addEventListener('click', () => { rotation -= 90; updatePreviewTransform(); });
        rotateRightBtn.addEventListener('click', () => { rotation += 90; updatePreviewTransform(); });
        flipHBtn.addEventListener('click', () => { scaleH *= -1; updatePreviewTransform(); });
        flipVBtn.addEventListener('click', () => { scaleV *= -1; updatePreviewTransform(); });
        
        function updateDimensionsFromInput(source) {
            let value = parseInt(source.value) || 0; if (value <= 0) return;
            const isSideways = rotation % 180 !== 0;
            const isWidthInput = source.id === 'widthInput';

            if ( (isWidthInput && !isSideways) || (!isWidthInput && isSideways) ) {
                singleFileData.currentWidth = value;
                if (singleFileData.isRatioLocked) {
                    singleFileData.currentHeight = Math.round(value / singleFileData.aspectRatio);
                    heightInput.value = isSideways ? singleFileData.currentWidth : singleFileData.currentHeight;
                }
            } else {
                 singleFileData.currentHeight = value;
                if (singleFileData.isRatioLocked) {
                    singleFileData.currentWidth = Math.round(value * singleFileData.aspectRatio);
                    widthInput.value = isSideways ? singleFileData.currentHeight : singleFileData.currentWidth;
                }
            }
            updateSliderFromDimensions();
            updateNewDimensionsDisplay();
        }
        widthInput.addEventListener('input', () => updateDimensionsFromInput(widthInput));
        heightInput.addEventListener('input', () => updateDimensionsFromInput(heightInput));
        
        function updateSliderFromDimensions() {
             const isSideways = rotation % 180 !== 0;
             const sliderBasedOn = isSideways ? singleFileData.currentHeight : singleFileData.currentWidth;
             const originalBasedOn = isSideways ? singleFileData.originalHeight : singleFileData.originalWidth;
            const percent = Math.round((sliderBasedOn / originalBasedOn) * 100);
            percentSlider.value = Math.min(Math.max(percent, 1), 400);
            
            percentValue.textContent = `${percentSlider.value}%`;
            if (percentSlider.value > 100) {
                percentValue.style.color = 'var(--primary-color)';
                percentValue.title = 'تكبير الصورة قد يؤثر على جودتها';
            } else {
                percentValue.style.color = 'inherit';
                percentValue.title = '';
            }
        }
        
        percentSlider.addEventListener('input', () => { 
            const percent = percentSlider.value;
            percentValue.textContent = `${percent}%`;

            if (percent > 100) {
                percentValue.style.color = 'var(--primary-color)';
                percentValue.title = 'تكبير الصورة قد يؤثر على جودتها';
            } else {
                percentValue.style.color = 'inherit';
                percentValue.title = '';
            }

            const isSideways = rotation % 180 !== 0;
            const newWidth = Math.round((singleFileData.originalWidth * percent) / 100);
            const newHeight = Math.round((singleFileData.originalHeight * percent) / 100);
            singleFileData.currentWidth = newWidth;
            singleFileData.currentHeight = newHeight;
            widthInput.value = isSideways ? newHeight : newWidth;
            heightInput.value = isSideways ? newWidth : newHeight;
            updateNewDimensionsDisplay();
        });

        aspectLock.addEventListener('click', () => {
            const lockIconClosed = aspectLock.querySelector('.lock-icon-closed');
            const lockIconOpen = aspectLock.querySelector('.lock-icon-open');

            singleFileData.isRatioLocked = !singleFileData.isRatioLocked;

            if (singleFileData.isRatioLocked) {
                lockIconClosed.style.display = 'block';
                lockIconOpen.style.display = 'none';
                aspectLock.title = 'قفل نسبة العرض إلى الارتفاع';
            } else {
                lockIconClosed.style.display = 'none';
                lockIconOpen.style.display = 'block';
                aspectLock.title = 'فتح نسبة العرض إلى الارتفاع';
            }

            if (singleFileData.isRatioLocked) {
                widthInput.dispatchEvent(new Event('input'));
            }
        });
        
        const toggleQualityControl = (formatEl, qualityEl) => {
            const isLossy = formatEl.value === 'jpeg' || formatEl.value === 'webp';
            qualityEl.classList.toggle('hidden', !isLossy);
        };
        formatSelect.addEventListener('change', () => toggleQualityControl(formatSelect, qualityControl));

        qualitySlider.addEventListener('input', () => {
            qualityValue.textContent = `${qualitySlider.value}%`;
        });

        function makeEditableOnClick(spanElement, sliderElement, options) {
            const { min, max } = options;
            
            spanElement.addEventListener('click', function onSpanClick() {
                if (document.querySelector('.editable-input')) return;

                const originalValue = parseInt(spanElement.textContent, 10);
                const input = document.createElement('input');
                input.type = 'number';
                input.className = 'editable-input';
                input.min = min;
                input.max = max;
                input.value = originalValue;
                input.style.width = '60px';
                input.style.textAlign = 'center';
                input.style.border = '1px solid var(--primary-color)';
                input.style.outline = 'none';
                input.style.borderRadius = '4px';
                input.style.fontWeight = '700';

                function finalize() {
                    let newValue = parseInt(input.value, 10);
                    if (isNaN(newValue)) {
                        newValue = originalValue;
                    }
                    newValue = Math.max(min, Math.min(newValue, max));
                    
                    sliderElement.value = newValue;
                    sliderElement.dispatchEvent(new Event('input', { bubbles: true }));

                    input.replaceWith(spanElement);
                }

                input.addEventListener('blur', finalize);
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        finalize();
                    } else if (e.key === 'Escape') {
                        input.replaceWith(spanElement);
                        spanElement.textContent = `${originalValue}%`;
                    }
                });

                spanElement.replaceWith(input);
                input.focus();
                input.select();
            });
        }

        makeEditableOnClick(percentValue, percentSlider, { min: 1, max: 400 });
        makeEditableOnClick(qualityValue, qualitySlider, { min: 1, max: 100 });
        
        // --- Download Logic ---
        async function processImage(image, newWidth, newHeight, format, quality, transform) {
            const isSideways = transform.rotation % 180 !== 0;
            const finalWidth = isSideways ? newHeight : newWidth;
            const finalHeight = isSideways ? newWidth : newHeight;
            if (finalWidth <= 0 || finalHeight <= 0) return null;
            if (finalWidth * finalHeight * 4 > MEMORY_LIMIT_BYTES) return null;

            const canvas = document.createElement('canvas');
            canvas.width = finalWidth;
            canvas.height = finalHeight;
            const ctx = canvas.getContext('2d');
            ctx.save();
            ctx.translate(canvas.width / 2, canvas.height / 2);
            ctx.rotate(transform.rotation * Math.PI / 180);
            ctx.scale(transform.scaleH, transform.scaleV);
            ctx.drawImage(image, -newWidth / 2, -newHeight / 2, newWidth, newHeight);
            ctx.restore();
            
            return await new Promise(resolve => canvas.toBlob(resolve, `image/${format}`, quality));
        }

        async function downloadSingleFile() {
            if (!singleFileData.originalImage) return;
            setDownloadButtonLoading(true);

            const { originalImage, currentWidth, currentHeight, name } = singleFileData;
            const format = formatSelect.value;
            const quality = (format === 'jpeg' || format === 'webp') ? parseInt(qualitySlider.value, 10) / 100 : undefined;
            
            const blob = await processImage(originalImage, currentWidth, currentHeight, format, quality, { rotation, scaleH, scaleV });

            if (blob) {
                const isSideways = rotation % 180 !== 0;
                const finalW = isSideways ? currentHeight : currentWidth;
                const finalH = isSideways ? currentWidth : currentHeight;
                const baseFileName = name.split('.').slice(0, -1).join('.') || name;
                const newFileName = `${baseFileName}_${finalW}x${finalH}.${format}`;
                triggerDownload(URL.createObjectURL(blob), newFileName);
            } else {
                showToast(`فشل التحويل.`);
            }
            setDownloadButtonLoading(false);
        }
        
        const setDownloadButtonLoading = (isLoading) => {
            downloadButton.classList.toggle('loading', isLoading);
            resetButton.disabled = isLoading;
        };

        const triggerDownload = (url, name) => {
            const a = document.createElement('a');
            a.href = url;
            a.download = name;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        const resetApp = () => {
            if(cropper) cropper.destroy(); cropper = null;
            imageEditor.style.display = 'none';
            singleEditorView.style.display = 'none';
            editorView.classList.remove('hidden');
            cropperView.classList.add('hidden');
            uploadArea.style.display = 'flex';
            pageTitle.style.display = 'block';
            fileInput.value = '';
            singleFileData = {};
        };
        
        downloadButton.addEventListener('click', () => {
            if (singleFileData.originalImage) downloadSingleFile();
        });
        resetButton.addEventListener('click', resetApp);
    });
    </script>
    
    <script>
    if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('sw.js').then(registration => { console.log('SW registration successful:', registration.scope); }).catch(err => { console.log('SW registration failed:', err); }); }); }
  </script>
  
</body>
</html>